/*! jQuery IndexedDB v0.2.2
(c) 2013 Amey Sakhadeo
MIT License: https://raw.github.com/ameyms/jquery-indexeddb/master/LICENSE */
if(!jQuery)throw new Error("jQuery Idb requires jQuery");!function(a,b){b.indexedDB||b.webkitIndexedDB||b.mozIndexedDB;var c=function(){var b=arguments[0],c=arguments[1],d=Array.prototype.splice.call(arguments,2),e=this.__db__,f=this,g=[];a.each(d,function(c,d){var h=e.transaction([b],"readwrite"),i=h.objectStore(b),j=i.put(d),k=a.Deferred();j.onsuccess=function(){k.resolveWith(f,[b,d])},j.onerror=function(a){k.rejectWith(f,[b,a.value,d])},g.push(k)}),a.when.apply(a,g).then(function(){c.resolveWith(f,arguments)},function(){c.rejectWith(f,arguments)})},d=function(b){var c=a.Deferred(),d=this,e=b.value,f=b.delete();return f.onsuccess=function(){c.resolveWith(d,[e])},f.onerror=function(){c.rejectWith(d,[e])},c},e=function(b,c){var d=a.Deferred(function(){this.idb=c,a.extend(this,b)});return d},f=function(){this.__db__=null};f.prototype.createStores=function(b){var c=this.__db__;a.each(b,function(a,b){c.objectStoreNames.contains(b.name)&&c.deleteObjectStore(b.name),c.createObjectStore(b.name,{keyPath:b.keyPath})})},f.prototype.deleteStores=function(b){var c=this.__db__;a.each(b,function(a,b){c.objectStoreNames.contains(b)&&c.deleteObjectStore(b)})},f.prototype.hasStore=function(a){var b=this.__db__;return b.objectStoreNames.contains(a)?!0:!1},f.prototype.addObjects=c,f.prototype.getObjects=function(a,b,c,d){var e=this,f=this.__db__,g=f.transaction([a],"readonly"),h=g.objectStore(a),i=h.openCursor(),j=[],k=d||this;i.onsuccess=function(a){var d=a.target.result,f=!0;return null===d?(b.resolveWith(e,[j]),void 0):(c&&(f=c.call(k,d.key,d.value)),f&&j.push(d.value),d.continue(),void 0)},i.onerror=function(a){b.rejectWith(e,[a])}},f.prototype.deleteObjects=function(b,c,e,f){var g=this,h=this.__db__,i=h.transaction([b],"readwrite"),j=i.objectStore(b),k=j.openCursor(),l=f||this,m=[];k.onsuccess=function(b){var f=b.target.result,h=!0;return null===f?(a.when.apply(a,m).then(function(){Array.prototype.push.call(arguments,[]),c.resolveWith(g,a.merge.apply(a,arguments))},function(){Array.prototype.push.call(arguments,[]),c.rejectWith(g,a.merge.apply(a,arguments))}),void 0):(e&&(h=e.call(l,f.key,f.value)),h&&m.push(d.call(g,f)),f.continue(),void 0)},k.onerror=function(a){c.rejectWith(g,[a])}},f.prototype.open=function(b){var c,d=e(g,this),f=[],h=[],i=this,j=1,k=[],l=[],m=[];"string"===a.type(b)?c=b:(c=b.name,j=b.version,f=b.stores||[],h=b.drop||[]);var n=indexedDB.open(c,j);return n.onupgradeneeded=function(a){i.__db__=a.target.result,d.idb=i,a.target.transaction.onerror=function(a){d.rejectWith(i,[a])},h&&i.deleteStores(h),f&&i.createStores(f)},n.onsuccess=function(b){i.__db__=b.target.result,d.idb=i,a.each(f,function(a,b){i.hasStore(b.name)?l.push(b.name):k.push(b.name)}),a.each(h,function(a,b){i.hasStore(b)&&m.push(b)}),k.length>0||m.length>0?d.rejectWith(i,[{present:l,absent:k,dropFailed:m}]):d.resolveWith(i)},n.onerror=function(a){d.rejectWith(i,[a])},d},f.prototype.clearStore=function(a,b){var c,d=this.__db__,e=d.transaction([a],"readwrite"),f=e.objectStore(a);c=f.clear(),c.onsuccess=function(){b.resolve()},c.onerror=function(a){b.rejectWith(a)}};var g={put:function(b,d){var e=a.Deferred(),f=d;return this.done(function(){var d=a.isArray(b)?b:[b];c.apply(this,a.merge([f,e],d))}),this.fail(function(a){e.rejectWith(this,[a])}),e},remove:function(b,c,d){var e=a.Deferred();return this.done(function(){this.deleteObjects(b,e,c,d)}),this.fail(function(a){e.rejectWith(this,[a])}),e},clear:function(b){var c=a.Deferred();return this.done(function(){this.clearStore(b,c)}),this.fail(function(a){c.rejectWith(this,[a])}),c},select:function(b,c,d){var e=a.Deferred();return this.done(function(){this.getObjects(b,e,c,d)}),this.fail(function(a){e.rejectWith(this,[a])}),e},all:function(a){return this.select(a)}};a.extend({idb:function(a,b){var c=new f;return c.open(a,b)}})}(jQuery,window);